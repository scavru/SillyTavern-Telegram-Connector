

# Коннектор SillyTavern для Telegram

SillyTavern Telegram Connector — это расширение для SillyTavern, которое позволяет пользователям взаимодействовать с ИИ-персонажами SillyTavern через Telegram. Расширение создает мост между SillyTavern и Telegram-ботом, позволяя общаться с любимыми ИИ-персонажами на мобильных устройствах в любое время и в любом месте.  
[![License](https://img.shields.io/github/license/qiqi20020612/SillyTavern-Telegram-Connector)](https://github.com/qiqi20020612/SillyTavern-Telegram-Connector/blob/main/LICENSE)
[![stars](https://img.shields.io/github/stars/qiqi20020612/SillyTavern-Telegram-Connector)](https://github.com/qiqi20020612/SillyTavern-Telegram-Connector)

## Основные функции

- **Интеграция с Telegram**: Общение с ИИ-персонажами SillyTavern через приложение Telegram.
- **Синхронизация в реальном времени**: Чаты в Telegram синхронизируются с интерфейсом SillyTavern и наоборот.
- **Поддержка команд**: Доступны различные команды Telegram для управления чатами и персонажами:
  - `/help` — Показать все доступные команды.
  - `/new` — Начать новый чат.
  - `/listchars` — Список всех доступных персонажей.
  - `/switchchar <имя персонажа>` — Переключиться на указанного персонажа.
  - `/listchats` — Список всех чатов текущего персонажа.
  - `/switchchat <имя чата>` — Переключиться на указанный чат.
- **Простая настройка**: Подключение через WebSocket, простое в установке и использовании.

## Установка и использование

### Установка расширения

1. В SillyTavern перейдите на вкладку "Extensions".
2. Нажмите "Install Extension".
3. Введите следующий URL: `https://github.com/qiqi20020612/SillyTavern-Telegram-Connector`.
4. Нажмите кнопку "Install".
5. После установки перезапустите SillyTavern.

### Настройка сервера

1. Склонируйте или скачайте этот репозиторий на свой компьютер.
2. Перейдите в директорию `server`.
3. Установите зависимости:
   ```
   npm install node-telegram-bot-api ws
   ```
4. Скопируйте файл `config.example.js` в `config.js`:
   ```
   cp config.example.js config.js
   ```
   или в Windows:
   ```
   copy config.example.js config.js
   ```
5. Отредактируйте файл `config.js`, заменив `YOUR_TELEGRAM_BOT_TOKEN_HERE` на ваш Telegram Bot Token
   (его можно получить через [@BotFather](https://t.me/BotFather) в Telegram).
6. Запустите сервер:
   ```
   node server.js
   ```

### Настройка подключения

1. В SillyTavern перейдите на вкладку "Extensions".
2. Найдите раздел "Telegram Connector".
3. В поле "Bridge сервер WebSocket URL" введите адрес WebSocket-сервера
   (по умолчанию `ws://127.0.0.1:2333`).
4. Нажмите кнопку "Подключить".
5. После появления статуса "Подключено" вы можете начать использование.

### Использование в Telegram

1. В Telegram найдите и начните диалог с созданным ботом.
2. Отправьте любое сообщение, чтобы начать чат.
3. Ваши сообщения будут отправлены в SillyTavern, а ответы ИИ автоматически вернутся в Telegram.
4. Используйте команду `/help`, чтобы просмотреть все доступные команды.

### Настройка переводчика (OneRingTranslator)

1. **Подключение к OneRingTranslator**:
   - Убедитесь, что у вас есть доступ к API OneRingTranslator. Получите API-ключ через их официальный сайт или документацию.
   - В файле `config.js` добавьте следующие параметры:
     ```
     translator: {
       enabled: true,
       apiKey: 'YOUR_ONERINGTRANSLATOR_API_KEY',
       apiUrl: 'https://api.oneringtranslator.com/translate'
     }
     ```
     Замените `YOUR_ONERINGTRANSLATOR_API_KEY` на ваш API-ключ.
   - Перезапустите сервер:
     ```
     node server.js
     ```

2. **Включение/отключение переводчика**:
   - Чтобы включить переводчик, установите `translator.enabled` в `true` в файле `config.js`.
   - Чтобы отключить переводчик, измените `translator.enabled` на `false` и перезапустите сервер.
   - Вы также можете управлять переводчиком через Telegram-команды (если реализовано в будущем):
     - `/enabletranslator` — Включить переводчик.
     - `/disabletranslator` — Отключить переводчик.

## Системные требования

- Node.js 14.0 или выше.
- Запущенный экземпляр SillyTavern.
- Подключение к интернету (для Telegram API).
- Для публичного доступа к серверу рекомендуется использовать HTTPS/WSS.

## Устранение неполадок

- **Проблемы с подключением**: Убедитесь, что WebSocket-сервер запущен, и URL настроен правильно.
- **Бот не отвечает**: Проверьте правильность Telegram Bot Token и наличие ошибок в логах сервера.
- **Сообщения не синхронизируются**: Убедитесь, что расширение SillyTavern подключено к WebSocket-серверу.

## Поддержка и участие

Если у вас возникли проблемы или есть предложения по улучшению, свяжитесь через:

- Создание Issue на GitHub.
- Контакт с автором: ZMou.
- Посещение сайта автора: https://zmoutech.cn.

Приветствуются Pull Request для улучшения расширения!

## Лицензия

Проект распространяется под лицензией GNU General Public License v3.0 (GPL-3.0) — подробности в файле LICENSE.

## TODO

- **Улучшение групповых чатов**:
  - [ ] Реакция на сообщения с упоминанием @bot в групповых чатах.

- **Поддержка медиа**:
  - [ ] Поддержка отправки изображений.

- **Форматирование сообщений**:
  - [ ] Реализация экранирования markdown.
  - [ ] Изменение способа обработки сообщений бота на HTML.

- **Оптимизация архитектуры**:
  - [x] Перенос обработки команд на сервер, исключение участия фронтенда в разборе команд.
  - [ ] Преобразование сервера в стандартный серверный плагин, соответствующий [спецификации серверных плагинов SillyTavern](https://docs.sillytavern.app/for-contributors/server-plugins/).

- **Улучшение пользовательского опыта**:
  - [x] Настройка частоты редактирования сообщений.
  - [x] Оптимизация потоковой передачи: отображение начального сообщения после генерации достаточного количества текста.
  - [ ] Состояние "Ввод текста" на протяжении всего процесса потокового ответа.
  - [x] Добавление команды `/ping` для проверки состояния подключения к Bridge и SillyTavern.

- **Меню настроек**:
  - [ ] Добавление настройки белого списка в меню расширения.
  - [ ] Управление отправкой уведомлений в Telegram при переключении персонажей и других действиях на веб-странице.

- **Обработка ошибок и стабильность**:
  - [ ] Исправление команды `/exit`, которая всегда завершается с ошибкой "Тайм-аут операции выхода, принудительный выход".
  - [x] Обработка события нажатия кнопки "Остановить генерацию" в ST (GENERATION_STOPPED вместо GENERATION_ENDED).
  - [ ] Обработка отправки нового сообщения во время генерации (перехват и уведомление пользователя о процессе генерации).
  - [ ] Очистка старого кэша состояния на сервере после команд `/switchchar` или `/switchchat`.

- **Техническая оптимизация**:
  - [ ] Реализация проверки активности браузера через WebSocket heartbeat.
  - [ ] Оптимизация обработки setTimeout для ожидания обновления DOM.

